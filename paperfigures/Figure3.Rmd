---
title: "Figure3"
author: "Joanna Kaplanis and Kaitlin Samocha"
date: "22/08/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
# load required libraries
library(data.table)
library(ggplot2)
library(dplyr)
library(tidyr)
library(rateratio.test)
library(wesanderson)

# filepaths
resfile <- "../input/extended_denovoWEST_results.tab"
gnomad_constraint_file <- '../input/gnomad.v2.1.1.lof_metrics.by_gene.txt.bgz'
hgnc_file <- '../input/protein-coding_gene.txt'
```

```{r}
# load results file
res <- fread(resfile,sep = "\t")
```

#Figure 3(a)  

```{r}
mypal = wes_palette("Zissou1")
res$cat <- res$diag_group
res$cat[res$diag_group == "none" & res$sig] <- "novel"
res$cat[res$cat == "none"] <- "unassociated"
respow <- rbind(res[res$sig],res[!res$sig & !res$consensus_gene & !res$discordant_gene])

ggplot(respow[!is.na(respow$cat),],aes(x = cat,y = powmed,fill = sig)) + geom_boxplot() + theme_classic() + labs(x = "",y = "Power (using median enrichment)")  + scale_fill_manual(values=c(mypal[5],mypal[1]),labels = c("not significant","significant")) + geom_boxplot(aes(color = sig),fatten = NULL, fill = NA, coef = 0, outlier.alpha = 0,show.legend = F)+
  theme(legend.position="top")

```
#Figure 3(b)   

#Figure 3(c)  

#Figure 3(d)  

```{r}
# determine bins
res %>%
  filter(lofe < 1e-6 & constraint_flag=='' & !(symbol %in% c('DNMT3A', 'ASXL1', 'PPM1D', 'TET2'))) %>%
  summarize(max = max(log10(lofratio)), min = min(log10(lofratio)), diff = max(log10(lofratio))-min(log10(lofratio)), steps = (max(log10(lofratio))-min(log10(lofratio)))/5)
```

```{r}
# find ptv and syn counts per bin
ptv_syn_gnomad <- res %>%
  filter(lofe < 1e-6 & constraint_flag=='' & !(symbol %in% c('DNMT3A', 'ASXL1', 'PPM1D', 'TET2'))) %>%
  mutate(lofbin = case_when(log10(lofratio) < 0.9618719+(1*0.3442909) ~ 1,
                            log10(lofratio) < 0.9618719+(2*0.3442909) & log10(lofratio) >= 0.9618719+(1*0.3442909) ~ 2,
                            log10(lofratio) < 0.9618719+(3*0.3442909) & log10(lofratio) >= 0.9618719+(2*0.3442909) ~ 3,
                            log10(lofratio) < 0.9618719+(4*0.3442909) & log10(lofratio) >= 0.9618719+(3*0.3442909) ~ 4,
                            log10(lofratio) >= 0.9618719+(4*0.3442909) ~ 5)) %>%
  group_by(lofbin) %>%
  summarise(genes = n(), ptv = sum(obs_lof), syn = sum(obs_syn), ptv_syn = sum(obs_lof)/sum(obs_syn)) %>%
  ungroup()

ptv_syn_gnomad$lower_bound <- apply(ptv_syn_gnomad, 1, function(row) rateratio.test(c(as.numeric(row[3]), as.numeric(row[4])), c(as.numeric(row[2]), as.numeric(row[2])))$conf[1])
ptv_syn_gnomad$upper_bound <- apply(ptv_syn_gnomad, 1, function(row) rateratio.test(c(as.numeric(row[3]), as.numeric(row[4])), c(as.numeric(row[2]), as.numeric(row[2])))$conf[2])

ptv_syn_gnomad
```

```{r}
# weighted regression
fit_weighted_lofbin_ptvsyn <- glm(ptv_syn ~ lofbin, data=ptv_syn_gnomad, weights = genes)
weighted_intercept <- fit_weighted_lofbin_ptvsyn$coefficients[[1]]
weighted_slope <- fit_weighted_lofbin_ptvsyn$coefficients[[2]]

summary(fit_weighted_lofbin_ptvsyn)
```

```{r, fig.align='center'}
ggplot(ptv_syn_gnomad, aes(x = lofbin, y = ptv_syn)) +
  geom_point(size=5) +
  theme_classic() +
  ylim(c(0,0.021)) +
  geom_errorbar(aes(ymin=lower_bound, ymax=upper_bound), width=.1) +
  labs(x='PTV enrichment bin', y = 'PTV/syn in gnomAD') +
  geom_abline(intercept = weighted_intercept, slope = weighted_slope, col='darkgray', linetype=2) +
  theme(axis.text.x  = element_text(size=14), axis.text.y = element_text(size=14), axis.title = element_text(size=16)) +
  scale_x_continuous(name = 'PTV enrichment bin', breaks = seq(1,5,1), labels = c('0.96-1.30\n(n=21)', '1.30-1.65\n(n=63)', '1.65-2.00\n(n=40)', '2.00-2.34\n(n=23)', '2.34-2.68\n(n=9)'))
```