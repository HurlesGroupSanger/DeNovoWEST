---
title: "Figure3"
author: "Joanna Kaplanis and Kaitlin Samocha"
date: "22/08/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
# load required libraries
library(data.table)
library(ggplot2)
library(dplyr)
library(tidyr)
library(rateratio.test)
library(wesanderson)
library(ggbeeswarm)

# filepaths
resfile <- "../input/extended_denovoWEST_results.tab"
usfile <- "../input/USabnormality_likelihood.csv"

```

```{r}
# load results file
res <- fread(resfile,sep = "\t")
```

#Figure 3(a)  

```{r}
mypal = wes_palette("Zissou1")
res$cat <- res$diag_group
res$cat[res$diag_group == "none" & res$sig] <- "novel"
res$cat[res$cat == "none"] <- "not-significant"
respow <- rbind(res[res$sig],res[!res$sig & !res$consensus_gene & !res$discordant_gene])

ggplot(respow[!is.na(respow$cat),],aes(x = cat,y = powmed,fill = sig)) + geom_boxplot() + theme_classic() + labs(x = "",y = "Power (using median enrichment)")  + scale_fill_manual(values=c(mypal[5],mypal[1]),labels = c("not significant","significant")) + geom_boxplot(aes(color = sig),fatten = NULL, fill = NA, coef = 0, outlier.alpha = 0,show.legend = F)+
  theme(legend.position="top",legend.title = element_blank(),legend.text = element_text(size = 14),axis.text=element_text(size=14),axis.title=element_text(size=16)) 

```
#Figure 3(b)   
```{r}
higenes <- res[res$lofe<=10^(-6) & res$sig,]
higenes$lglofratio <- log10(higenes$lofratio)
p <- ggplot(higenes, aes(x=diag_group, y=lglofratio, fill = diag_group)) + labs(y = "log10(observed/expected PTVs)") + 
  geom_boxplot(notch = F,color = "gray40") + scale_fill_manual(values = c("black", '#56B4E9', "#E69F00")) + 
  theme_classic() +theme(legend.position = "none")+
  #geom_jitter(position = position_jitter(0.1),color = "gray40") +
  xlab("Diagnostic group")+
  geom_beeswarm(aes(color = group),priority = 'ascending',color = "gray40",cex = 1.8)+
  theme(axis.text=element_text(size=14),axis.title=element_text(size=16)) 
dat <- ggplot_build(p)$data[[1]]
p
```
#Figure 3(c)  

```{r}
traffic <- c("#4CBB17","#FF7800","#E60000")

cl <- fread(usfile,sep = ",")
cl$lik_anomaly <- cl$`Likelihood of anomalies identified on antenatal USS`
#clinfo <- merge(cl,res,by.x = c("Symbol"),by.y = c("symbol"),all.x = T)
all <- merge(cl,res,by.x = c("Symbol"),by.y = c("symbol"),all.x = T)

expcounts <- aggregate(all$lofexpected,by = list(all$lik_anomaly),FUN = sum,na.rm = T)
obscounts <- aggregate(all$lofcount,by = list(all$lik_anomaly),FUN = sum,na.rm = T)
poisson.test(obscounts$x[c(1,3)],T =  expcounts$x[c(1,3)])
poisson.test(obscounts$x[c(1,2)],T =  expcounts$x[c(1,2)])
poisson.test(c(obscounts$x[1],obscounts$x[2]+obscounts$x[3]),T = c(expcounts$x[1],expcounts$x[2] + expcounts$x[3]))
ci.lower <- sapply(obscounts$x, function(x) poisson.test(x,conf.level = 0.95)$conf.int[1])/expcounts$x
ci.upper <- sapply(obscounts$x, function(x) poisson.test(x,conf.level = 0.95)$conf.int[2])/expcounts$x

pdf("~/Documents/PhD/denovo_enrichment/plots_for_paper/prenatal.pdf",width = 4,height = 5)
bp <- barplot(obscounts$x/expcounts$x,ylim = c(0,60),names.arg = c("low","medium","high"),xlab = "Genes' likelihood of US abnormality",ylab = "PTV enrichment",col = traffic,border = NA)
arrows(bp[,1],ci.lower,bp[,1],ci.upper,length = 0,lwd = 1.5)
dev.off()
```
#Figure 3(d)  

```{r}
# determine bins
res %>%
  filter(lofe < 1e-6 & constraint_flag=='' & !(symbol %in% c('DNMT3A', 'ASXL1', 'PPM1D', 'TET2'))) %>%
  summarize(max = max(log10(lofratio)), min = min(log10(lofratio)), diff = max(log10(lofratio))-min(log10(lofratio)), steps = (max(log10(lofratio))-min(log10(lofratio)))/5)
```

```{r}
# find ptv and syn counts per bin
ptv_syn_gnomad <- res %>%
  filter(lofe < 1e-6 & constraint_flag=='' & !(symbol %in% c('DNMT3A', 'ASXL1', 'PPM1D', 'TET2'))) %>%
  mutate(lofbin = case_when(log10(lofratio) < 0.9618719+(1*0.3442909) ~ 1,
                            log10(lofratio) < 0.9618719+(2*0.3442909) & log10(lofratio) >= 0.9618719+(1*0.3442909) ~ 2,
                            log10(lofratio) < 0.9618719+(3*0.3442909) & log10(lofratio) >= 0.9618719+(2*0.3442909) ~ 3,
                            log10(lofratio) < 0.9618719+(4*0.3442909) & log10(lofratio) >= 0.9618719+(3*0.3442909) ~ 4,
                            log10(lofratio) >= 0.9618719+(4*0.3442909) ~ 5)) %>%
  group_by(lofbin) %>%
  summarise(genes = n(), ptv = sum(obs_lof), syn = sum(obs_syn), ptv_syn = sum(obs_lof)/sum(obs_syn)) %>%
  ungroup()

ptv_syn_gnomad$lower_bound <- apply(ptv_syn_gnomad, 1, function(row) rateratio.test(c(as.numeric(row[3]), as.numeric(row[4])), c(as.numeric(row[2]), as.numeric(row[2])))$conf[1])
ptv_syn_gnomad$upper_bound <- apply(ptv_syn_gnomad, 1, function(row) rateratio.test(c(as.numeric(row[3]), as.numeric(row[4])), c(as.numeric(row[2]), as.numeric(row[2])))$conf[2])

ptv_syn_gnomad
```

```{r}
# weighted regression
fit_weighted_lofbin_ptvsyn <- glm(ptv_syn ~ lofbin, data=ptv_syn_gnomad, weights = genes)
weighted_intercept <- fit_weighted_lofbin_ptvsyn$coefficients[[1]]
weighted_slope <- fit_weighted_lofbin_ptvsyn$coefficients[[2]]

summary(fit_weighted_lofbin_ptvsyn)
```

```{r, fig.align='center'}
ggplot(ptv_syn_gnomad, aes(x = lofbin, y = ptv_syn)) +
  geom_point(size=5) +
  theme_classic() +
  ylim(c(0,0.021)) +
  geom_errorbar(aes(ymin=lower_bound, ymax=upper_bound), width=.1) +
  labs(x='PTV enrichment bin', y = 'PTV/syn in gnomAD') +
  geom_abline(intercept = weighted_intercept, slope = weighted_slope, col='darkgray', linetype=2) +
  theme(axis.text.x  = element_text(size=14), axis.text.y = element_text(size=14), axis.title = element_text(size=16)) +
  scale_x_continuous(name = 'PTV enrichment bin', breaks = seq(1,5,1), labels = c('0.96-1.30\n(n=21)', '1.30-1.65\n(n=63)', '1.65-2.00\n(n=40)', '2.00-2.34\n(n=23)', '2.34-2.68\n(n=9)'))
```